name: Daily Stock Update

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas requests

      - name: Run Fetch Script
        run: |
          python -c "
          import requests, json, time
          stocks = ['2330', '0050', '006208', 'TAIEX']
          result = {}
          for s in stocks:
              print(f'Fetching {s}...')
              url = f'https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id={s}&start_date=2016-01-01'
              try:
                  r = requests.get(url)
                  raw = r.json().get('data', [])
                  # 自動判斷欄位 (相容個股與大盤)
                  fmt = []
                  for d in raw:
                      fmt.append({
                          't': d.get('date'),
                          'o': d.get('open') or d.get('開盤價'),
                          'h': d.get('max') or d.get('最高價'),
                          'l': d.get('min') or d.get('最低價'),
                          'c': d.get('close') or d.get('收盤價')
                      })
                  result[s] = fmt
                  time.sleep(1)
              except:
                  print(f'Error fetching {s}')

          with open('data.json', 'w', encoding='utf-8') as f:
              json.dump(result, f, ensure_ascii=False)
          "

      - - name: Commit and Push
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'action@github.com'
          git pull --rebase origin main  # 先拉取最新版本並合併
          git add data.json
          git commit -m 'Update stock data' || exit 0
          git push origin main
